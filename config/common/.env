.SECONDEXPANSION:

################################################################
## environment specific configs - REQUIRES UPDATE BEYOND SA TEAM
################################################################

SHELL 								= /bin/bash
ENVIRONMENT						= kalm-main-16-1
ENVIRONMENT_SHORT     = $(shell echo ${ENVIRONMENT} | cut -d- -f1-2)

##################################################################################
# BUILD VARIABLES
##################################################################################

VERSION 							= $(shell git describe --tags --exact-match 2>/dev/null || git symbolic-ref -q --short HEAD)
BUILD_DATE 						= $(shell date +%FT%T%z)

## Getting local git repository details prior
GIT_COMMIT_ID         = $(shell git rev-parse --short HEAD 2>/dev/null)
GIT_BRANCH_NAME       = $(shell git rev-parse --abbrev-ref HEAD | head -c14)

# Git Repo URL for Blueprint Description details
GIT_REPO_URL          = $(shell git remote get-url origin | rev | cut -c5- | rev)

# Blueprint Git Tag remove dot notation because dots are not allowed in Blueprint Naming
BP_GIT_TAG            = $(shell git rev-list --tags --max-count=1 | xargs -I {} git describe --tags {} | tr -d '.')

# Marketplace Git Tag leaves dot notation and remove 'v' character to stay in line with existing semantic versioning guidelines
MP_GIT_TAG            = $(shell git rev-list --tags --max-count=1 | xargs -I {} git describe --tags {} | tr -d 'v')

COMMON_CONFIG_DIR			= $(CURDIR)/config/common
ENV_CONFIG_DIR				= $(CURDIR)/config/${ENVIRONMENT}
ENV_BUILD_CACHE				= ${ENV_CONFIG_DIR}/.cache

##################################################################################
# GLOBAL SECRETS
##################################################################################

ARTIFACTORY_PASS 			= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .artifactory_password - )
CALM_DSL_USER 				= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .calm_dsl_user - )
CALM_DSL_PASS 				= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .calm_dsl_pass - )

NUTANIX_KEY_USER 			= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .nutanix_key_user - )
NUTANIX_USER 					= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .nutanix_user - )
NUTANIX_PASS 					= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .nutanix_password - )

PRISM_CENTRAL_USER 		= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .prism_central_user - )
PRISM_CENTRAL_PASS 		= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .prism_central_password - )
PRISM_ELEMENT_USER 		= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .prism_element_user - )
PRISM_ELEMENT_PASS 		= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .prism_element_password - )

WINDOWS_DOMAIN_ADMIN 	= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .windows_domain_user - )
WINDOWS_DOMAIN_PASS 	= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .windows_domain_password - )

TENANT_ID 						= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .azure_tenant_id - )
SUBSCRIPTION_ID 			= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .azure_subscription_id - )
CLIENT_ID 						= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .azure_client_id - )
CLIENT_SECRET 				= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .azure_client_secret - )

NUTANIX_KEY  = $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .nutanix_key - )
NUTANIX_PUBLIC_KEY      = $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .nutanix_public_key - )

DOCKER_HUB_USER 		= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .docker_hub_user - )
DOCKER_HUB_PASS 		= $(shell helm secrets view config/${ENVIRONMENT}/secrets.yaml | yq eval .docker_hub_password - )

# Default Configs defined below:

##################################################################################
# PRISM CENTRAL DEFAULTS
##################################################################################

# requires .calm/.local/prism_central_password to be configured
PC_USER = ${PRISM_CENTRAL_USER}
PC_PASS = ${PRISM_CENTRAL_PASS}
PC_CRED = ${PRISM_CENTRAL_USER}:${PRISM_CENTRAL_PASS}
PC_PORT = 9440
PE_PORT	=	9440

##################################################################################
# CALM INFRA DEFAULTS
##################################################################################

CALM_PROJECT	=	default

DSL_INIT_PARAMS   ?= --ip ${PC_IP_ADDRESS} --port ${PC_PORT} --username ${PC_USER} --password ${PC_PASS}
#-d .local/${ENVIRONMENT}/dsl.db -cf .local/${ENVIRONMENT}/config.ini -ld .local/${ENVIRONMENT}

# setting dsl bp to execute
DSL_BP						?= karbon_cluster_deployment

KUBECTL_CONTEXT	:= ${KARBON_CLUSTER}-context
KARBON_API_ENDPOINT	:=  https://${PC_IP_ADDRESS}:9440/karbon

##################################################################################
# AZURE DEFAULTS
##################################################################################

AZURE_AGENT_POOL=Default
AZURE_AGENT_VERSION=2.184.2

## explicitly required for Azure Agent VM
AZURE_PIPELINE_URL=https://dev.azure.com/sa-cloud-infra

KALM_ID=$(shell echo ${ENVIRONMENT} | cut -d- -f3)
KALM_INSTANCE=$(shell echo ${ENVIRONMENT} | cut -d- -f4)
SUBNET_PREFIX=10.38.${KALM_ID}

## explicitly for Kasten Karbon Cluster - Multi-Cluster - OPTIONAL
PRIMARY_KASTEN_K8S_CLUSTER=kalm-main-${KALM_INSTANCE}

## domain configs
DOMAIN_NAME=ntnxlab.local
## calm environment specifics
CALM_PROJECT=BootcampInfra
## storage container info
PE_STORAGE_CONTAINER=Default
## file server specifics
FILE_SERVER_NAME=BootcampFS
## objects server specifics
OBJECTS_SERVER=ntnx-objects
## ahv network ipam config
IPAM_VLAN=Primary

## explicitly for anthos_on_ahv - OPTIONAL TODO: REMOVE NEED
IPAM_VLAN_UUID=100b3686-4075-4c5b-8104-b7ff3e969fad

## set hpoc specific default vars based on KALM_INSTANCE
## to find available IPS - `nmap -sn -n ${SUBNET_PREFIX}.64/26 -v -oG - | grep "Down" | awk '{print $2,$4,$5}'`
## IF KALM_INSTANCE is equal to 1, then network will most likely fall in 10.38.x.0/26 network - 10.38.x.12-10.38.x.30 seems to be safe range.
## IF KALM_INSTANCE is equal to 2, .64/26 scenario - 10.38.x.80 - 10.38.x.105 seems to be safe range.
## IF KALM_INSTANCE is equal to 3, .128/25 scenario - 10.38.x.210 - 10.38.x.230 seems to be safe range
## IF KALM_INSTANCE is equal to 4, .192/26 scenario - 10.38.x.210 - 10.38.x.230 seems to be safe range

## i.e., PHX-SPOC-15-1
ifeq (${KALM_INSTANCE},1)
  ## network configs
  NETWORK=${SUBNET_PREFIX}.0
  GATEWAY=${SUBNET_PREFIX}.1
  CIDR=26
  ## prism central / element configs
  PE_CLUSTER_VIP=${SUBNET_PREFIX}.7
  PE_DATASERVICES_VIP=${SUBNET_PREFIX}.8
  PC_IP_ADDRESS=${SUBNET_PREFIX}.9
  ## ldap / dns configs
  DNS=${SUBNET_PREFIX}.11
  ## explicitly for objects
  OBJECTS_PUBLIC_IP=${SUBNET_PREFIX}.41
  ifeq (${ENVIRONMENT_SHORT},kalm-main)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.12
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.13
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.13-${SUBNET_PREFIX}.14
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.16
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.17
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.17-${SUBNET_PREFIX}.18
  endif
  ifeq (${ENVIRONMENT_SHORT},kalm-develop)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.20
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.21
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.21-${SUBNET_PREFIX}.22
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.23
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.24
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.24-${SUBNET_PREFIX}.25
  endif
endif

## i.e., PHX-SPOC-15-2
ifeq (${KALM_INSTANCE},2)
  ## network configs
  NETWORK=${SUBNET_PREFIX}.64
  GATEWAY=${SUBNET_PREFIX}.65
  CIDR=26
  ## prism central / element configs
  PE_CLUSTER_VIP=${SUBNET_PREFIX}.71
  PE_DATASERVICES_VIP=${SUBNET_PREFIX}.72
  PC_IP_ADDRESS=${SUBNET_PREFIX}.73
  ## ldap / dns configs
  DNS=${SUBNET_PREFIX}.75
  ## explicitly for objects
  OBJECTS_PUBLIC_IP=${SUBNET_PREFIX}.98
  ifeq (${ENVIRONMENT_SHORT},kalm-main)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.80
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.81
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.81-${SUBNET_PREFIX}.82
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.84
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.85
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.85-${SUBNET_PREFIX}.86
  endif
  ifeq (${ENVIRONMENT_SHORT},kalm-develop)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.88
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.89
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.89-${SUBNET_PREFIX}.90
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.92
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.93
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.93-${SUBNET_PREFIX}.94
  endif
endif

# ## i.e., PHX-SPOC-15-3
ifeq (${KALM_INSTANCE},3)
  ## network configs
  NETWORK=${SUBNET_PREFIX}.128
  GATEWAY=${SUBNET_PREFIX}.129
  CIDR=26
  ## prism central / element configs
  PE_CLUSTER_VIP=${SUBNET_PREFIX}.135
  PE_DATASERVICES_VIP=${SUBNET_PREFIX}.136
  PC_IP_ADDRESS=${SUBNET_PREFIX}.137
  ## ldap / dns configs
  DNS=${SUBNET_PREFIX}.139
  ## explicitly for objects
  OBJECTS_PUBLIC_IP=${SUBNET_PREFIX}.TBD
  ifeq (${ENVIRONMENT_SHORT},kalm-main)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.145
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.146
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.146-${SUBNET_PREFIX}.147
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.149
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.150
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.150-${SUBNET_PREFIX}.151
  endif
  ifeq (${ENVIRONMENT_SHORT},kalm-develop)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.153
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.154
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.154-${SUBNET_PREFIX}.155
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.157
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.158
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.158-${SUBNET_PREFIX}.159
  endif
endif

# ## i.e., PHX-SPOC-15-4
ifeq (${KALM_INSTANCE},4)
  ## network configs
  NETWORK=${SUBNET_PREFIX}.192
  GATEWAY=${SUBNET_PREFIX}.193
  CIDR=26
  ## prism central / element configs
  PE_CLUSTER_VIP=${SUBNET_PREFIX}.199
  PE_DATASERVICES_VIP=${SUBNET_PREFIX}.200
  PC_IP_ADDRESS=${SUBNET_PREFIX}.201
  ## ldap / dns configs
  DNS=${SUBNET_PREFIX}.203
  ## explicitly for objects
  OBJECTS_PUBLIC_IP=${SUBNET_PREFIX}.TBD
  ifeq (${ENVIRONMENT_SHORT},kalm-main)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.208
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.209
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.209-${SUBNET_PREFIX}.210
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.212
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.213
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.213-${SUBNET_PREFIX}.214
  endif
  ifeq (${ENVIRONMENT_SHORT},kalm-develop)
    KARBON_EXT_IPV4=${SUBNET_PREFIX}.216
    KARBON_INGRESS_VIP=${SUBNET_PREFIX}.217
    KARBON_LB_ADDRESSPOOL=${SUBNET_PREFIX}.217-${SUBNET_PREFIX}.218
    ## explicitly for anthos_on_ahv
    ANTHOS_CONTROLPLANE_VIP=${SUBNET_PREFIX}.220
    ANTHOS_INGRESS_VIP=${SUBNET_PREFIX}.221
    ANTHOS_LB_ADDRESSPOOL=${SUBNET_PREFIX}.221-${SUBNET_PREFIX}.222
  endif
endif

# karbon blueprint default configs

## set karbon specific configs. kalm-main is production-like
ifeq (${ENVIRONMENT_SHORT},kalm-main)
  KARBON_CLUSTER_TYPE=Production - Multi-Master Active/Passive
  KARBON_WORKER_COUNT=3
else
  KARBON_CLUSTER_TYPE=Development
  KARBON_WORKER_COUNT=1
endif

KARBON_CLUSTER=${ENVIRONMENT}
KARBON_VLAN=${IPAM_VLAN}
KARBON_CONTAINER_OS_VER=ntnx-1.2
KARBON_K8S_VER=1.19.13-1
KARBON_CNI_NAME=Calico
KARBON_STORAGE_CONTAINER=${PE_STORAGE_CONTAINER}
## external IP can be set, even if not used in Development config
WILDCARD_INGRESS_DOMAIN=${KARBON_CLUSTER}.${DOMAIN_NAME}
KARBONCTL_WS_ENDPOINT=karbonctlws.${DOMAIN_NAME}

# calm configs
CALM_ENVIRONMENT=${ENVIRONMENT_SHORT}

# file server configs
FILE_SERVER_DNS=${FILE_SERVER_NAME}.${DOMAIN_NAME}
FILE_SERVER_NFS_NAME=${ENVIRONMENT_SHORT}-nfs

# objects configs
OBJECTS_DNS=${OBJECTS_SERVER}.${DOMAIN_NAME}
OBJECTS_BUCKET=${KARBON_CLUSTER}-k10-bucket
OBJECTS_BUCKET_DNS=${OBJECTS_BUCKET}.${OBJECTS_DNS}

# share k8s distro configs
NTNX_CSI_URL=http://download.nutanix.com/csi/v2.3.1/csi-v2.3.1.tar.gz
NTNX_PE_IP=${PE_CLUSTER_VIP}
NTNX_PE_PORT=${PE_PORT}
NTNX_PE_DATASERVICE_IP=${PE_DATASERVICES_VIP}
NTNX_PE_STORAGE_CONTAINER=${KARBON_STORAGE_CONTAINER}
NTNX_PC_IP=${PC_IP_ADDRESS}

# Anthos configs
ANTHOS_CLUSTER_NAME=anthos-${ENVIRONMENT}
ANTHOS_PODS_NETWORK=172.30.0.0/16
ANTHOS_SERVICES_NETWORK=172.31.0.0/16
KUBERNETES_SERVICE_ACCOUNT=google-cloud-console
OS_DISK_SIZE=128
PYTHON_ANTHOS_GENCONFIG=https://raw.githubusercontent.com/pipoe2h/calm-dsl/anthos-on-ahv/blueprints/anthos-on-ahv/scripts/anthos_generate_config.py
ANTHOS_VERSION=1.6.1

# Rke configs
RKE_CLUSTER_NAME=rke-${ENVIRONMENT}
RKE2_CLUSTER_NAME=rke2-${ENVIRONMENT}