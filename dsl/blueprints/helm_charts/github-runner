
custom-values.yaml

authSecret:
  github_token: REPLACE_YOUR_TOKEN_HERE
  create: true


helm repo add actions-runner-controller https://actions-runner-controller.github.io/actions-runner-controller


helm install --wait --namespace actions-runner-system --create-namespace actions-runner-controller actions-runner-controller/actions-runner-controller \
  --set authSecret.github_token="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" \
  --set authSecret.create=true


helm repo add actions-runner-controller https://actions-runner-controller.github.io/actions-runner-controller
helm upgrade --install --namespace actions-runner-system --create-namespace \
             --wait actions-runner-controller actions-runner-controller/actions-runner-controller \
             --set authSecret.github_token="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" \
             --set authSecret.create=true
            

kubectl --namespace actions-runner-system get all

# app.kubernetes.io/instance=actions-runner-controller

## Add Self Hosted Runners

kubectl create namespace self-hosted-runners --dry-run=client -o yaml | kubectl apply -f -

GITHUB_REPO_URL=https://github.com/jesse-gonzalez/cloud-native-calm.git
GITHUB_REPO_URL_WO_SUFFIX="${GITHUB_REPO_URL%.*}"
GITHUB_REPO_ORG="$(basename "${GITHUB_REPO_URL_WO_SUFFIX}")"
GITHUB_REPO_NAME="$(basename "${GITHUB_REPO_URL_WO_SUFFIX%/${GITHUB_REPO_ORG}}")"
GITHUB_REPO_SLUG="$GITHUB_REPO_NAME/$GITHUB_REPO_ORG"

echo $GITHUB_REPO_SLUG

cat <<EOF | kubectl apply -n self-hosted-runners -f -
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: runner-deployment
spec:
  template:
    spec:
      repository: $( echo $GITHUB_REPO_SLUG)
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: runner-deployment-autoscaler
spec:
  scaleTargetRef:
    name: runner-deployment
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: TotalNumberOfQueuedAndInProgressWorkflowRuns
    repositoryNames:
    - $( echo $GITHUB_REPO_SLUG)
EOF
